package core

import (
	"fmt"
	"time"

	"topgear/internal/analyzer"
	"topgear/internal/discovery"
	"topgear/internal/ui"
)

type Engine struct {
	networkRecon *discovery.NetworkRecon
	analyzer     *analyzer.ThreatAnalyzer
	ui           *ui.TerminalUI
}

func NewEngine() *Engine {
	return &Engine{
		networkRecon: discovery.NewNetworkRecon(),
		analyzer:     analyzer.New(),
		ui:           ui.New(),
	}
}

func (e *Engine) Scan(target string) error {
	startTime := time.Now()

	e.ui.ShowBanner()
	e.ui.ShowScanStart(target, "Comprehensive Security Assessment")

	// Phase 1: Network Discovery, Port Scanning, System Info, and Nmap integration
	e.ui.ShowProgress("Performing comprehensive network reconnaissance...")
	reconResults := e.networkRecon.ComprehensiveRecon()
	if reconResults == nil {
		e.ui.Error("Comprehensive reconnaissance failed: received nil results")
		return fmt.Errorf("comprehensive reconnaissance failed")
	}
	time.Sleep(500 * time.Millisecond)

	// Phase 4: Threat Analysis
	e.ui.ShowProgress("Security analysis and risk assessment")
	threats := e.analyzer.Analyze(reconResults)
	time.Sleep(400 * time.Millisecond)

	// Phase 5: Results
	e.ui.ShowResults(threats)
	e.ui.ShowScanComplete(time.Since(startTime))
	return nil
}
