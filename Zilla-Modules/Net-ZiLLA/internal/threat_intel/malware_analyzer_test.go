package threat_intel

import (
	"testing"
)

func TestMalwareAnalyzer_AnalyzeScript(t *testing.T) {
	ma := NewMalwareAnalyzer()
	
	// Test safe script
	res1 := ma.AnalyzeScript("console.log('hello')")
	if res1.RiskScore > 20 {
		t.Errorf("safe script flagged with high risk: %d", res1.RiskScore)
	}
	
	// Test suspicious script (eval + b64)
	res2 := ma.AnalyzeScript("eval(atob('W21hbGljaW91cyBjb2RlXQ=='))")
	if res2.RiskScore < 50 {
		t.Errorf("malicious script NOT flagged with high risk: %d", res2.RiskScore)
	}
}

func TestMalwareAnalyzer_DetectScriptType(t *testing.T) {
	ma := NewMalwareAnalyzer()
	
	if typ := ma.detectScriptType("#!/bin/bash\necho 1"); typ != "Shell" {
		t.Errorf("expected Shell, got %s", typ)
	}
	
	if typ := ma.detectScriptType("function test() {}"); typ != "JavaScript" {
		t.Errorf("expected JavaScript, got %s", typ)
	}
}

func TestMalwareAnalyzer_FileAndSignature(t *testing.T) {
	ma := NewMalwareAnalyzer()
	
	sig := MalwareSignature{
		Hash:     "d41d8cd98f00b204e9800998ecf8427e",
		Name:     "Test Trojan",
		Severity: "CRITICAL",
	}
	ma.AddMalwareSignature(sig)
	
	sigs := ma.GetMalwareSignatures()
	found := false
	for _, s := range sigs {
		if s.Hash == sig.Hash {
			found = true
			break
		}
	}
	if !found {
		t.Error("signature not found after addition")
	}
	
	ma.RemoveMalwareSignature(sig.Hash)
	sigs = ma.GetMalwareSignatures()
	for _, s := range sigs {
		if s.Hash == sig.Hash {
			t.Error("signature found after removal")
		}
	}
}

