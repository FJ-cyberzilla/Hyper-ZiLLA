# Dockerfile
FROM golang:1.21-alpine AS backend

WORKDIR /app
COPY backend/go.mod backend/go.sum ./
RUN go mod download

COPY backend/ ./
RUN CGO_ENABLED=0 GOOS=linux go build -o cognizilla cmd/cognizilla/main.go

FROM node:18-alpine AS frontend
WORKDIR /app
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ ./
RUN npm run build

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/

# Copy backend binary
COPY --from=backend /app/cognizilla .
# Copy frontend build
COPY --from=frontend /app/dist ./web

# Create non-root user
RUN adduser -D -s /bin/sh cognizilla
USER cognizilla

# Quantum security layer
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD ./cognizilla health-check

EXPOSE 8080 8443
ENTRYPOINT ["./cognizilla"]
CMD ["--quantum", "--sovereign"]
